<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 FINAL//EN">

<HTML>
<HEAD><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=ISO-8859-1">

<TITLE>TCP Chorusing</TITLE>

</HEAD>

<BODY  BGCOLOR="#000000" LINK="#0000FF" VLINK="#800080" TEXT="#000000" TOPMARGIN=0 LEFTMARGIN=0 MARGINWIDTH=0 MARGINHEIGHT=0>
<CENTER>
<TABLE CELLPADDING=0 CELLSPACING=0 BORDER=0 WIDTH=712>
<TR VALIGN="top" ALIGN="left">
<TD>

  <TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=510>
   <TR VALIGN="top" ALIGN="left">
	<TD></TD>
   </TR>
   <TR VALIGN="top" ALIGN="left">
	<TD HEIGHT =30></TD>
   </TR>
  </TABLE>
  <TABLE BORDER=0 CELLSPACING=0 CELLPADDING=0 WIDTH=510>
   <TR VALIGN="top" ALIGN="left">
	<TD WIDTH=500 ROWSPAN=3>
	  <TABLE id="Table185" BORDER=0 BGCOLOR="#FFFFFF" CELLSPACING=0 CELLPADDING=0  WIDTH=500 >
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500>&nbsp;</TD>
	 </TR>
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500>
<P ALIGN="CENTER"><B><FONT SIZE="+2" FACE="Courier New,Courier"><U>TCP Chorusing in the<BR>Windows 9x TCP/IP Stack<BR><BR></U>A Preliminary Analysis<BR><BR>By </FONT></B><A HREF="mailto:effugas@best.com"><B><FONT SIZE="+2" FACE="Courier New,Courier">Dan Kaminsky</FONT></B></A><B><FONT SIZE="+2" FACE="Courier New,Courier"><BR>&nbsp;</FONT></B></TD>
	 </TR>
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500>
<P>
<TABLE WIDTH=450 BORDER=0 CELLSPACING=0 CELLPADDING=0 ALIGN=LEFT><TR>
<TD>
	  <TABLE id="Table211" BORDER=0 CELLSPACING=0 CELLPADDING=0  WIDTH=450 >
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=340 BGCOLOR="#000000"><TABLE BORDER=0 CELLSPACING=0 CELLPADDING=7 WIDTH=340><TR><TD>

<P><B><FONT COLOR="#FFFFFF" SIZE="+1" FACE="Arial,Helvetica,Univers,Zurich BT">Abstract</FONT></B></TD></TR></TABLE></TD>
		<TD WIDTH=110 BGCOLOR="#000000">
<P><FONT COLOR="#FFFFFF" SIZE="-1" FACE="Arial,Helvetica,Univers,Zurich BT">02-Feb-1999<BR></FONT><A HREF="mailto:effugas@best.com"><FONT COLOR="#FFFFFF" SIZE="-1" FACE="Arial,Helvetica,Univers,Zurich BT">Dan Kaminsky</FONT></A><FONT COLOR="#FFFFFF" SIZE="-1" FACE="Arial,Helvetica,Univers,Zurich BT"></FONT></TD>
	 </TR>
	  </TABLE></TD></TR></TABLE>
&nbsp;</TD>
	 </TR>
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500><TABLE BORDER=0 CELLSPACING=0 CELLPADDING=7 WIDTH=500><TR><TD>

<P>Microsoft Windows 95 and 98 clients have the capability to bind multiple TCP/IP stacks to the same MAC address, simply by having the protocol added more than once in the Network control panel.&nbsp; This is actually quite useful, except for the fact that these stacks can run concurrently on the same IP, even if they receive their IP through BOOTP/DHCP.&nbsp; The effect of the bug is to cause the number of ACKnowledgement packets sent to be equal to that of the number of loaded and bound TCP/IP stacks, creating excessive and significant network noise and collisions.&nbsp; At least one Samba 2.0.0beta1 server on an affected subnet can become completely inaccessible when one of these machines start misbehaving.</P>
<P>Redundant ACKing can be referred to as TCP Chorusing, due to the minor time delays introduced between multiple copies of identical data.&nbsp; The problem is undetectable using the Ping command built into Windows 95 or 98--this is a significant bug in and of itself.&nbsp; Linux압 ping is not similarly crippled.&nbsp; NT was not available for testing.<BR>&nbsp;</TD></TR></TABLE></TD>
	 </TR>
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500>
<P>
<TABLE WIDTH=450 BORDER=0 CELLSPACING=0 CELLPADDING=0 ALIGN=LEFT><TR>
<TD>
	  <TABLE id="Table210" BORDER=0 CELLSPACING=0 CELLPADDING=0  WIDTH=450 >
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=340 BGCOLOR="#000000"><TABLE BORDER=0 CELLSPACING=0 CELLPADDING=7 WIDTH=340><TR><TD>

<P><B><FONT COLOR="#FFFFFF" SIZE="+1" FACE="Arial,Helvetica,Univers,Zurich BT">Introduction:&nbsp; Discovery</FONT></B></TD></TR></TABLE></TD>
		<TD WIDTH=110 BGCOLOR="#000000">&nbsp;</TD>
	 </TR>
	  </TABLE></TD></TR></TABLE>
&nbsp;</TD>
	 </TR>
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500><TABLE BORDER=0 CELLSPACING=0 CELLPADDING=7 WIDTH=500><TR><TD>

<P><I>A word of warning: This is the first edition of this document and there are bound to be errors.&nbsp; My ego isn't so fragile as to be bothered if I made a misstatement of fact when writing this.&nbsp; Just </I><A HREF="mailto:effugas@best.com"><I>tell me.</I></A><I></P>
<P></I>My <A HREF="http://www.scu.edu">university</A> possesses a generally excellent network, but on occasion certain dorms would grind to a halt for no apparent reason.&nbsp; Seeking answers, I used a windows platform pinger to see if there were correlations between network downtimes and the presence of specific IP압 on a specific subnet.&nbsp; We use essentially static IP압 distributed from a DHCP server--a cookie seems to be assigned to a given MAC address on first request for an IP, and all future IP압 are given on that IP.&nbsp; Nothing out of the ordinary was found using the Windows pingers, so I decided I앇 automate the testing process over time using an excellent Linux tool entitled <A HREF="http://www.stanford.edu/~schemers/docs/fping/fping.html">fping</A>.&nbsp; (In another environment, I might have merely shoved up a sniffer, but the secure hubs and my lack of permission to modify them in any way prevented that possibility.</P>
<P>Very quickly, I noticed some very strange entries in the fping logs(IP압 changed):</P>
<P><FONT FACE="Courier New,Courier"><TT>10.0.9.42 : duplicate for [3], 84 bytes, 3.28 ms<BR>10.0.9.73 : duplicate for [3], 84 bytes, 3.59 ms<BR>10.0.10.33 : duplicate for [3], 84 bytes, 3.51 ms<BR>10.0.10.99 : duplicate for [3], 84 bytes, 3.81 ms</P>
<P></TT></FONT>I thought there might be a bug in fping, so I pinged the offending machines from Windows 98:</P>
<P><FONT FACE="Courier New,Courier"><TT>C:\WINDOWS&gt;ping -f 10.0.9.42<BR><BR>Pinging 10.0.9.42 with 32 bytes of data:<BR><BR>Reply from 10.0.9.42: bytes=32 time=4ms TTL=126<BR>Reply from 10.0.9.42: bytes=32 time=3ms TTL=126<BR>Reply from 10.0.9.42: bytes=32 time=4ms TTL=126<BR>Reply from 10.0.9.42: bytes=32 time=3ms TTL=126<BR><BR>Ping statistics for 10.0.9.42:<BR>&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<BR>Approximate round trip times in milli-seconds:<BR>&nbsp;&nbsp;&nbsp; Minimum = 3ms, Maximum =&nbsp; 4ms, Average =&nbsp; 3ms</P>
<P></TT></FONT>Confusing, everything seemed normal from here.&nbsp; Then I tried the Linux ping command.</P>
<P><FONT FACE="Courier New,Courier"><TT>effugas@doxpara:~&gt; ping 10.0.9.42<BR>PING 10.0.9.42 (10.0.9.42): 56 data bytes<BR>64 bytes from 10.0.9.42: icmp_seq=0 ttl=127 time=3.5 ms<BR>64 bytes from 10.0.9.42: icmp_seq=0 ttl=127 time=14.7 ms (DUP!)<BR>64 bytes from 10.0.9.42: icmp_seq=1 ttl=127 time=6.2 ms<BR>64 bytes from 10.0.9.42: icmp_seq=1 ttl=127 time=7.5 ms (DUP!)<BR>64 bytes from 10.0.9.42: icmp_seq=2 ttl=127 time=3.3 ms<BR>64 bytes from 10.0.9.42: icmp_seq=2 ttl=127 time=3.8 ms (DUP!)<BR>64 bytes from 10.0.9.42: icmp_seq=3 ttl=127 time=15.0 ms<BR>64 bytes from 10.0.9.42: icmp_seq=3 ttl=127 time=15.4 ms (DUP!)<BR><BR>--- 10.0.9.42 ping statistics ---<BR>4 packets transmitted, 4 packets received, +4 duplicates, 0% packet loss<BR>round-trip min/avg/max = 3.3/8.6/15.4 ms</P>
<P></TT></FONT>This <I>was</I> disturbing, especially since there was a very high correlation between subnets experiencing high collisions and slow networks and the number of TCP-Chorusing machines on that subnet.&nbsp; What was causing this?&nbsp; The first step was to hunt down the machines exhibiting the bug and do a little exploratory surgery.&nbsp; It didn't take much deduction once I got access to a few of the affected machines to realize that there were the same number of extra TCP/IP stacks bound to the main adapter as there were extra pings.&nbsp; Plus, just because there were machines with extra stacks didn't mean it wasn't the NIC압 fault--a bug in the NIC installer could have have created the extra TCP/IP entries.&nbsp; And what about wiring?&nbsp; All of these machines were exhibiting these reactions on a rather non-standard "secure hub".&nbsp; Perhaps that was the cause of the stacks reacting so strangely?</P>
<P>Further investigation did shed some light.&nbsp; The automated installation routines are suspect, since theyre the routines that most commonly add the stacks.&nbsp; All cards, though, from generic Linksys압 to an Intel 8255x 10/100 board to the entire bevy of PCI and PCMCIA that 3Com offers can have additional TCP/IP stacks merely added onto them for this behavior.&nbsp; While only 3Com cards have been seen by me suffering from unintentional TCP/IP Chorusing, <I>this is probably because of the 90%+ market share 3Com enjoys on campus and not because of a flaw in their drivers</I>.&nbsp; It압 quite likely that, since students and not staff install network drivers on campus, this is more of a wetware problem--the student does whatever he or she can to "just make it work like the directions say", and if adding TCP/IP multiple times happens to "Just Work", so be it.</P>
<P>Before I could be sure that this was the problem, though, I needed to isolate a computer from the University network first.&nbsp; I used my dorm room 100baseT internal network to do so.&nbsp; The following tcpdump is from a single character typed from the chorusing machine into the telnet port of the Linux machine:</P>
<P><FONT FACE="Courier New,Courier"><TT>11:31:02.390000 10.0.6.195.1043 &gt; 10.0.6.194.telnet: P 6:7(1) ack 171 win 7756 (DF) <B>[Initial Keypress]<BR></B>11:31:02.390000 10.0.6.194.telnet &gt; 10.0.6.195.1043: P 171:172(1) ack 7 win 16352 (DF) <B>[Pressed key is echoed from the Linux machine to be displayed on the Windows box.]<BR></B>11:31:02.390000 10.0.6.195.1043 &gt; 10.0.6.194.telnet: . ack 172 win 7755 (DF) <B>[Windows machine acknowledges receipt of data signifying what character it should display.]<BR></B>11:31:02.390000 10.0.6.195.1043 &gt; 10.0.6.194.telnet: . ack 172 win 7755 (DF) <B>[Windows machine <I>again</I> acknowledges receipt.&nbsp; This is the "chorus".]</P>
<P></B></TT></FONT>There압 most probably no limit to the number of extra ACKs--If I had ten TCP/IP stacks, I앇 have nine duplicate packets, as far as I can tell.</P>
<P>A final note--I have thus far been able to locate the bug in Windows 98 and Windows 95 OSR2.&nbsp; The original version of Windows 95 was simply unavailable for testing, but I would appreciate an <A HREF="mailto:effugas@best.com">email</A> verifying the bug harkens back that far.<BR>.</TD></TR></TABLE></TD>
	 </TR>
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500>
<P>
<TABLE WIDTH=450 BORDER=0 CELLSPACING=0 CELLPADDING=0 ALIGN=LEFT><TR>
<TD>
	  <TABLE id="Table212" BORDER=0 CELLSPACING=0 CELLPADDING=0  WIDTH=450 >
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=340 BGCOLOR="#000000"><TABLE BORDER=0 CELLSPACING=0 CELLPADDING=7 WIDTH=340><TR><TD>

<P><B><FONT COLOR="#FFFFFF" SIZE="+1" FACE="Arial,Helvetica,Univers,Zurich BT">Impact of Bug</FONT></B></TD></TR></TABLE></TD>
		<TD WIDTH=110 BGCOLOR="#000000">&nbsp;</TD>
	 </TR>
	  </TABLE></TD></TR></TABLE>
&nbsp;</TD>
	 </TR>
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500><TABLE BORDER=0 CELLSPACING=0 CELLPADDING=7 WIDTH=500><TR><TD>

<P>The impact of TCP Chorusing, barring significant installer bugs(possible), is directly related to the extent to which non-technical users have installed network hardware and software.&nbsp; With millions of computers hooked up to college dormitories, it would be quite myopic to dismiss this population as minimal.&nbsp; Still, the relatively small percentage of machines on campus here(maybe 1%) suggests the problem isn앖 too prevalent.</P>
<P>It should be noted, though, that TCP Chorusing <I>can</I> wreak havoc.&nbsp; It only takes one, possibly two TCP Chorusers on the same subnet as my Samba 2.0.0beta1 server to render it inaccessible.&nbsp; Logs appear to show that the Windows machines time-out attempting to connect to the machine, but the problem is quite difficult to debug due to the bug압 moderately uncommon nature--the server only occasionally becomes disabled by the Chorusers.&nbsp; Attempts to connect to other 9x machines on the affected subnet still remain successful, however.&nbsp; There were no NT machines available to test with, but they앇 probably remain intact as long as the overall network remained usable.</P>
<P>However, four TCP Chorusers on a moderately active network will rend it unusable.&nbsp; My theory, completely unsubstantiated by observation(I do not possess local sniff capability) is that since additional packets are being sent out by the interface--one per stack per packet to acknowledge--and since these additional packets are sent out nearly simultaneously, theyre much more likely to cause collisions than randomly distributed packets.&nbsp; Ethernet handles collisions based on random backoff within one to ten 512 bit slot times--5.2ms on a 10mbit network.&nbsp; Since the ACK packets are generated simultaneously and pretty much must be delivered(lest a <I>new</I> packet come to replace it), they stream themselves over the line as soon as an incoming packet comes in, possibly colliding with packets from other nodes, <I>possibly even colliding with other incoming packets</I> from the same host.&nbsp; Empirical evidence shows that a network becomes near unusable with four TCP Chorusers on--assuming 1.5 duplicate packets per node, that압 10 ACKs for each packet being sent down the line if all four of them are simultaneously attempting to acknowledge received data--and, yes, these ACKs can collide with each other, leading to a reverberating feedback effect.&nbsp; That significantly overloads the backoff system, and the ether becomes unusable.&nbsp; <I>That압 my theory, for now.</P>
<P></I>It압 unknown at this time whether or not this bug affects modem users.&nbsp; If it does, it압 an extremely significant bug, considering the reduced bandwidth of SLIP/PPP.</P>
<P>Extra TCP/IP stacks listed in the registry but not active under Network Neighborhood do <I>not</I> appear to generate duplicate packets.&nbsp; The probability for a machine sending out duplicate packets to be suffering from multiple active TCP/IP stacks is 100% within the observed sample set at Santa Clara University.</P>
<P>One final note--when scanning for affected machines, be sure to deliver at least two or three pings to each client.&nbsp; There is a degree of intermittance with this bug.<BR>&nbsp;</TD></TR></TABLE></TD>
	 </TR>
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500>
<P>
<TABLE WIDTH=450 BORDER=0 CELLSPACING=0 CELLPADDING=0 ALIGN=LEFT><TR>
<TD>
	  <TABLE id="Table213" BORDER=0 CELLSPACING=0 CELLPADDING=0  WIDTH=450 >
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=340 BGCOLOR="#000000"><TABLE BORDER=0 CELLSPACING=0 CELLPADDING=7 WIDTH=340><TR><TD>

<P><B><FONT COLOR="#FFFFFF" SIZE="+1" FACE="Arial,Helvetica,Univers,Zurich BT">Solutions</FONT></B></TD></TR></TABLE></TD>
		<TD WIDTH=110 BGCOLOR="#000000">&nbsp;</TD>
	 </TR>
	  </TABLE></TD></TR></TABLE>
&nbsp;</TD>
	 </TR>
	 <TR VALIGN="top" ALIGN="left">
		<TD WIDTH=500><TABLE BORDER=0 CELLSPACING=0 CELLPADDING=7 WIDTH=500><TR><TD>

<P>Adminstrators should download and run <A HREF="http://www.stanford.edu/~schemers/docs/fping/fping.html">fping</A> to scan their networks for machines that respond multiple times to pings.&nbsp; It doesn앖 take much more than removing the excess stackage and rebooting to make a chorusing machine normal again.&nbsp; From the router/hub side, there압 not much that can be done since the right MAC is asking for the right IP--multiple times, yes, but still valid.&nbsp; Some extra software on the router end might be able to help.&nbsp; But to really fix this, MS needs to change the behavior of TCP/IP stacks.</P>
<P>Microsoft <I>should not</I> make a one-tcp/ip-stack-per-device limit--this reduces much of the effectiveness of Windows as a TCP/IP client.&nbsp; Rather, a simple check should be instituted so that no two TCP/IP stacks will attempt to provide services to the same IP.<BR>&nbsp;</TD></TR></TABLE></TD>
	 </TR>
	  </TABLE></TD>
   </TR>
  </TABLE></TD>
</TR>

	  </TABLE></TD>
   </TR>
  </TABLE></TD>
</TR>
</TABLE>
</BODY>
</HTML>
